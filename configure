#!/bin/bash

# Write error line to log (now stdout) and exit with error code 1
# Argument: the error to log
function log_error() {
    if [ "$1" ]; then
        echo "[configure] ERROR: $1"
    fi
    exit 1
}

# Write line to log (now stdout)
# Argument: the line to log
function log() {
    if [ "$1" ]; then
        echo "[configure] $1"
    fi
}

# Write variable for Makefile in Makefile configuration file
# Argument: name of variable
# Argument (optional): value of variable
function makefile_export() {
    if [ -z "$1" ]; then
        log_error "Invalid call to makefile_export"
        return
    fi
    if [ "$2" ]; then
       echo "export $1 = $2" >> $makefile_conf_file
    else
        echo "export $1" >> $makefile_conf_file
    fi
}

# Check and set variable and export to Makefile
# Argument: name of variable
# Argument (optional): default value if no value is set
function check_variable() {
    if [ -z $1 ]; then
        log_error "Invalid call to check_variable"
        return
    fi
    if [ "${!1}" ]; then
        makefile_export $1 "${!1}"
    else
        export $1="$2"
        makefile_export $1 "$2"
    fi
}

# Check that folder exists and create it if it doesn't
# Argument: name of the folder
function check_folder() {
    if [ -z $1 ]; then
        log_error "Invalid call to check_folder"
        return
    fi
    if [ -a $1 -a ! -d $1 ]; then
        log_error "Folder $1 cannot be created"
    elif [ ! -a $1 ]; then
        mkdir -vp $1
    fi
}

makefile_conf_file=configure.mk

if [ -f configure.mk ]; then
    mv -v configure.mk configure.mk.old
fi

echo "# Autogenerated configuration file. Do not modify" > $makefile_conf_file

# Export enviroment variables
check_variable ROOT_DIR "${PWD}"

# Check system folders
check_variable BIN_DIR "${ROOT_DIR}/bin"
check_folder $BIN_DIR

check_variable LIB_DIR "${BIN_DIR}/Architecture/Libraries"
check_variable LIB_FLAG "-L$LIB_DIR"
check_folder $LIB_DIR

check_variable INCLUDE_DIR_GEN "${BIN_DIR}/Architecture/Include"
check_folder $INCLUDE_DIR_GEN

check_variable INCLUDE_DIR "${ROOT_DIR}/src/Architecture/Include"
check_folder $INCLUDE_DIR

check_variable INCLUDE_FLAG "-I$INCLUDE_DIR -I$INCLUDE_DIR_GEN"

check_folder "${BIN_DIR}/Architecture/SDB"

# Export / update system variables
if [ "$LD_LIBRARY_PATH" ]; then
    makefile_export LD_LIBRARY_PATH "$LD_LIBRARY_PATH:$LIB_DIR"
else
    makefile_export LD_LIBRARY_PATH "$LIB_DIR"
fi
makefile_export SHELL $SHELL

# Check configuration variables
check_variable CFLAGS "-Wall -Wextra -Werror"
check_variable INCLUDE_FLAGS "-I"
check_variable HOST_CC "gcc"
check_variable GUEST_CC "gcc"
check_variable ANDROID_CC "gcc"
check_variable ARDUINO_CC "gcc"
check_variable TEST_FILE "ABS-test.log"
